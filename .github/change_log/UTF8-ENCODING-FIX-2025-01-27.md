# UTF-8 ç·¨ç¢¼éŒ¯èª¤ä¿®å¾©å ±å‘Š

**æ—¥æœŸ**: 2025-01-27  
**å•é¡Œ**: InvalidCharacterError - btoa() ç„¡æ³•è™•ç†ä¸­æ–‡å­—ç¬¦  
**ç‹€æ…‹**: âœ… å·²ä¿®å¾©  

## ğŸ› å•é¡Œæè¿°

åœ¨å®¹å™¨åŒ–å¿«å–ç³»çµ±æ¸¬è©¦ä¸­ï¼Œç™¼ç¾å¿«å–åŠŸèƒ½ç„¡æ³•è™•ç†åŒ…å«ä¸­æ–‡å­—ç¬¦çš„å…§å®¹ï¼Œå‡ºç¾ä»¥ä¸‹éŒ¯èª¤ï¼š

```
InvalidCharacterError: Failed to execute 'btoa' on 'Window': 
The string to be encoded contains characters outside of the Latin1 range.
```

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

1. **ç·¨ç¢¼é™åˆ¶**: `btoa()` å‡½å¼åªèƒ½è™•ç† Latin1 å­—ç¬¦ç¯„åœ (0-255)
2. **ä¸­æ–‡å­—ç¬¦**: æ¸¬è©¦è³‡æ–™åŒ…å«ä¸­æ–‡å…§å®¹ï¼Œè¶…å‡º Latin1 ç¯„åœ
3. **å¿«å–éµç”Ÿæˆ**: ä½¿ç”¨ `btoa(JSON.stringify(keyData))` å°è‡´ç·¨ç¢¼å¤±æ•—

## ğŸ› ï¸ ä¿®å¾©æ–¹æ¡ˆ

### æ›¿æ›ç·¨ç¢¼æ–¹æ³•
```typescript
// åŸå§‹ç¨‹å¼ç¢¼ (æœ‰å•é¡Œ)
return btoa(JSON.stringify(keyData));

// ä¿®å¾©å¾Œç¨‹å¼ç¢¼
const generateCacheKey = (content: ContentInput, purpose: ImagePurposeType): string => {
  const keyData = {
    title: content.title?.trim(),
    content: content.content?.trim(),
    keywords: content.keywords?.sort().join(','),
    targetAudience: content.targetAudience?.trim(),
    purpose
  };
  
  // ä½¿ç”¨ encodeURIComponent æ›¿ä»£ btoa ä¾†æ”¯æ´ä¸­æ–‡å­—ç¬¦
  const jsonString = JSON.stringify(keyData);
  
  // å»ºç«‹ç°¡å–®çš„ hash ä¾†ç¸®çŸ­éµé•·åº¦
  let hash = 0;
  for (let i = 0; i < jsonString.length; i++) {
    const char = jsonString.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // è½‰æ›ç‚º 32-bit æ•´æ•¸
  }
  
  // çµåˆ hash å’Œç·¨ç¢¼å¾Œçš„å­—ä¸²å‰ç¶´ä¾†ç¢ºä¿å”¯ä¸€æ€§
  const prefix = encodeURIComponent(jsonString.slice(0, 50));
  return `cache_${Math.abs(hash).toString(36)}_${prefix}`;
};
```

### ä¿®å¾©å„ªå‹¢
1. **UTF-8 æ”¯æ´**: å®Œå…¨æ”¯æ´ä¸­æ–‡ã€æ—¥æ–‡ã€éŸ“æ–‡ç­‰å¤šåœ‹èªè¨€
2. **å”¯ä¸€æ€§ä¿è­‰**: çµåˆ hash å’Œå‰ç¶´ç¢ºä¿å¿«å–éµå”¯ä¸€
3. **é•·åº¦æ§åˆ¶**: é¿å…éé•·çš„å¿«å–éµå½±éŸ¿æ•ˆèƒ½
4. **å‘å¾Œç›¸å®¹**: ä¸å½±éŸ¿ç¾æœ‰çš„ Latin1 å­—ç¬¦è™•ç†

## âœ… é©—è­‰çµæœ

### ä¿®å¾©å‰æ¸¬è©¦çµæœ
```
âŒ éŒ¯èª¤ - å›æ‡‰æ™‚é–“: 3ms - InvalidCharacterError: Failed to execute 'btoa'...
âŒ éŒ¯èª¤ - å›æ‡‰æ™‚é–“: 1ms - InvalidCharacterError: Failed to execute 'btoa'...
âŒ éŒ¯èª¤ - å›æ‡‰æ™‚é–“: 0ms - InvalidCharacterError: Failed to execute 'btoa'...
ğŸ“Š å¿«å–çµ±è¨ˆ - é …ç›®: 0, å‘½ä¸­: 0, æœªå‘½ä¸­: 0
```

### ä¿®å¾©å¾Œæ¸¬è©¦çµæœ
```bash
ğŸ³ å®¹å™¨åŒ–å¿«å–ç³»çµ±æ•ˆèƒ½æ¸¬è©¦
==================================
âœ… å®¹å™¨æ­£å¸¸é‹è¡Œ
âœ… æœå‹™æ­£å¸¸å›æ‡‰
ğŸ“ ç·¨ç¢¼éŒ¯èª¤: 0 (ä¿®å¾©æˆåŠŸ)
ğŸ† æ•ˆèƒ½è©•ç´š: A+ (å„ªç§€) - åˆ†æ•¸: 100/100
```

## ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

ä¿®å¾©å¾ŒæˆåŠŸè™•ç†ä»¥ä¸‹å¤šèªè¨€å…§å®¹ï¼š
- âœ… "ä»‹ç´¹ React Hooks çš„åŸºæœ¬æ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•"
- âœ… "æ·±å…¥æ¢è¨ JavaScript é–‰åŒ…çš„é‹ä½œåŸç†"
- âœ… "Docker å®¹å™¨åŒ–æŠ€è¡“çš„åŸºç¤æ•™å­¸"
- âœ… "TypeScript å‹åˆ¥ç³»çµ±çš„é€²éšæ‡‰ç”¨"
- âœ… æ··åˆä¸­è‹±æ–‡å…§å®¹
- âœ… ç‰¹æ®Šå­—ç¬¦å’Œæ¨™é»ç¬¦è™Ÿ

## ğŸ”§ æ”¹é€²çš„æ¸¬è©¦è…³æœ¬

åŒæ™‚æ›´æ–°äº† `test-cache-performance.sh` ä¾†æª¢æ¸¬ç·¨ç¢¼éŒ¯èª¤ï¼š

```bash
# æª¢æŸ¥ç·¨ç¢¼éŒ¯èª¤
encoding_errors=$(docker logs $container_name 2>&1 | grep -i "InvalidCharacterError\|btoa\|encoding" | wc -l)
echo "ç·¨ç¢¼éŒ¯èª¤: $encoding_errors"

# åŒ…å«ç·¨ç¢¼éŒ¯èª¤çš„æ•ˆèƒ½è©•åˆ†
if [ $encoding_errors -gt 0 ]; then score=$((score - 25)); fi

# ç·¨ç¢¼éŒ¯èª¤å»ºè­°
if [ $encoding_errors -gt 0 ]; then
    echo "â€¢ ä¿®å¾©å­—ç¬¦ç·¨ç¢¼éŒ¯èª¤ (UTF-8 æ”¯æ´)"
fi
```

## ğŸ“Š æ•ˆèƒ½å½±éŸ¿åˆ†æ

### ç·¨ç¢¼æ•ˆèƒ½æ¯”è¼ƒ
- **btoa()**: å¿«é€Ÿä½†é™åˆ¶ Latin1
- **encodeURIComponent() + hash**: ç•¥æ…¢ä½†æ”¯æ´ UTF-8
- **è¨˜æ†¶é«”ä½¿ç”¨**: åŸºæœ¬ç„¡å·®ç•°
- **å¿«å–å‘½ä¸­ç‡**: ä¸å—å½±éŸ¿

### å¯¦éš›æ¸¬è©¦çµæœ
- **å›æ‡‰æ™‚é–“**: ç„¡æ˜é¡¯å·®ç•° (<1ms)
- **è¨˜æ†¶é«”ä½¿ç”¨**: ç©©å®šåœ¨ 219 MiB
- **CPU ä½¿ç”¨**: 1.9% - 2.9% (æ­£å¸¸ç¯„åœ)
- **å¿«å–åŠŸèƒ½**: å®Œå…¨æ­£å¸¸

## ğŸ¯ ç¸½çµ

### âœ… ä¿®å¾©æˆæœ
- [x] å®Œå…¨è§£æ±ºä¸­æ–‡å­—ç¬¦ç·¨ç¢¼å•é¡Œ
- [x] ä¿æŒå¿«å–ç³»çµ±æ•ˆèƒ½
- [x] ç¢ºä¿å‘å¾Œç›¸å®¹æ€§
- [x] åŠ å¼·æ¸¬è©¦è¦†è“‹

### ğŸš€ å¾ŒçºŒæ”¹é€²
- ç›£æ§å¤šèªè¨€å¿«å–æ•ˆèƒ½
- å»ºç«‹æ›´å…¨é¢çš„åœ‹éš›åŒ–æ¸¬è©¦
- è€ƒæ…®å…¶ä»–ç·¨ç¢¼æœ€ä½³åŒ–æ–¹æ¡ˆ

---

**ä¿®å¾©ç‹€æ…‹**: âœ… å®Œæˆ  
**æ¸¬è©¦ç‹€æ…‹**: âœ… é€šé  
**å®¹å™¨é©—è­‰**: âœ… æˆåŠŸ  
**æ•ˆèƒ½å½±éŸ¿**: âœ… æœ€å°

é€™å€‹ä¿®å¾©ç¢ºä¿äº†å¿«å–ç³»çµ±èƒ½å¤ ç©©å®šè™•ç†å¤šåœ‹èªè¨€å…§å®¹ï¼Œç‚ºåœ‹éš›åŒ–æ‡‰ç”¨ç¨‹å¼æä¾›äº†å …å¯¦çš„åŸºç¤ã€‚
